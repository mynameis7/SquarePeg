
<html>
<head>
<title>SquarePeg VR WebApp</title>
<style>
	#canvas {
	position: absolute;
	top: 0; bottom: 0;
	left: 0; right: 0;
	}
	#video {
	position: absolute;
	left: -9999em;
	}
</style>

</head>
<body>
	<div id="canvas"></div>
	<canvas id="c"></canvas>
	<video id="video" autoplay loop>
	<source src="overpass-clip.mp4" type="video/mp4"></source>
	Your browser does not support the video element
	</video>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
	<script src="js/third-party/threejs/StereoEffect.js"></script>
	<script src="js/third-party/threejs/DeviceOrientationControls.js"></script>
	<script src="js/third-party/threejs/OrbitControls.js"></script>
	<script src="js/paper.js"></script>
	
	<script>
	var clock = new THREE.Clock();
	init();
	
	function init() {
	renderer = new THREE.WebGLRenderer();
	element = renderer.domElement;
	container = document.getElementById('canvas');
	container.appendChild(element);
	scene = new THREE.Scene();
	}
	
	var sphere = new THREE.SphereGeometry(500, 60, 40);
	sphere.applyMatrix(new THREE.Matrix4().makeScale(-1, 1, 1));
	
	var video = document.getElementById('video');
	function bindPlay () {
	video.play();
	document.body.removeEventListener('click', bindPlay);
	}
	document.body.addEventListener('click', bindPlay, false);
	
	
	var videoTexture = new THREE.VideoTexture(video);
	videoTexture.minFilter = THREE.LinearFilter;
	console.log(videoTexture);
	var videoMaterial = new THREE.MeshBasicMaterial({
	map: videoTexture
	});
	videoMesh = new THREE.Mesh(sphere, videoMaterial);
	
	
	effect = new THREE.StereoEffect(renderer);
	camera = new THREE.PerspectiveCamera(95, 1, 0.001, 700)
	
	camera.position.set(100, 100, 100);
	scene.add(camera);
	
	controls = new THREE.OrbitControls(camera, element);
	controls.rotateUp(Math.PI / 4);
	controls.target.set(
	camera.position.x + 0.1,
	camera.position.y,
	camera.position.z
	);
	controls.noZoom = true;
	controls.noPan = true;
	
	
	function setOrientationControls(e) {
	if (!e.alpha) {
	return;
	}
	controls = new THREE.DeviceOrientationControls(camera, true);
	controls.connect();
	controls.update();
	
	window.removeEventListener('deviceorientation', setOrientationControls, true);
	}
	
	window.addEventListener('deviceorientation', setOrientationControls, true);

	scene.add(videoMesh);
	window.addEventListener('resize', resize, false);
	animate();
	
	function resize () {
	var width = container.offsetWidth;
	var height = container.offsetHeight;
	camera.aspect = width / height;
	camera.updateProjectionMatrix();
	renderer.setSize(width, height);
	effect.setSize(width, height);
	}


	function getImageData(image) {
		//var canvas = document.createElement('canvas');
		var canvas = document.getElementById("c");
		canvas.width = image.scrollWidth/100;
		canvas.height = image.scrollHeight/100;

		var context = canvas.getContext('2d');
		context.drawImage(image, 0, 0, canvas.width, canvas.width);

		return context.getImageData(0, 0, image.scrollWidth, image.scrollHeight);
	}



	var is2D = false;


	function is2DFunc() {
		var idata = getImageData(videoTexture.image)
		/*var count = 0;
		var r=0, b=0, g=0;
		for(var i = 0; i < data.length; i += 4) {
			r = data[i];
			g = data[i+1];
			b = data[i+2];
			if(r === 0 && g === 0 && b === 0) {
				count += 1;
			}
		}
		if(count/(frm.width * frm.height) >= 0.5)
			return true;*/
		return false;
	}
	
	function update (dt) {
		resize();
		controls.update(dt);
		is2D = is2DFunc();
	}
	
	function render () {
		effect.render(scene, camera);
	}
	
	function animate () {
		requestAnimationFrame(animate);
		update(clock.getDelta());
		render();
	}
	
	function fullscreen () {
		if (container.requestFullscreen) {
		container.requestFullscreen();
		} else if (container.msRequestFullscreen) {
		container.msRequestFullscreen();
		} else if (container.mozRequestFullScreen) {
		container.mozRequestFullScreen();
		} else if (container.webkitRequestFullscreen) {
		container.webkitRequestFullscreen();
		}
	}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	</script>
	
</body>
</html>